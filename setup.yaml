---
- hosts: all
  # Fix this. Serializing everything would be slower just to give the first node a chance to init
  serial: 1
  tasks:
   - name: Do a pre-install sanity check - hostname
     command: hostname
     changed_when: false
     register: hostname_output
   - debug: var=hostname_output.stdout_lines

   - name: Do a pre-install OS config - firewalld stop
     command: systemctl stop firewalld
     changed_when: false
   - name: Do a pre-install OS config - firewalld disable
     command: systemctl disable firewalld
     changed_when: false

   # Install some tools to help with debugging later on
   - name: Install yum and net-tools to help with debugging
     command: sudo yum install nano net-tools -y
     changed_when: false

   # Scylla pre-install housekeeping
   - name: Remove ABRT and confirm
     command: sudo yum remove abrt -y
     changed_when: false
   - name: Install epel-release and confirm
     command: sudo yum install epel-release -y
     changed_when: false
   # NOTE TO SELF: Use the built in ansible add repo function and dont be a savage.
   - name: Add ScyllaDB repo
     command: sudo curl -o /etc/yum.repos.d/scylla.repo -L http://downloads.scylladb.com/rpm/centos/scylla-5.2.repo -v
     changed_when: false
   - name: Install latest version of ScyllaDB and confirm
     command: sudo yum install scylla -y
     changed_when: false
     register: installpackages_output
   - debug: var=installpackages_output.stdout_lines
   - name: Output installed ScyllaDB version
     command: scylla --version
     changed_when: false
     register: version_output
   - debug: var=version_output.stdout_lines

   # Modifying the scylla.yaml before setup
   - name: Add cluster name to scylla.yaml
     ansible.builtin.replace:
       path: /etc/scylla/scylla.yaml
       regexp: "#cluster_name: 'Test Cluster'"
       replace: "cluster_name: 'Ansible Scylla'"
   - name: Change listen_address in scylla.yaml
     ansible.builtin.lineinfile:
       path: /etc/scylla/scylla.yaml
       regexp: "listen_address: "
       line: "listen_address: {{ inventory_hostname }}"
   - name: Change rpc_address in scylla.yaml
     ansible.builtin.lineinfile:
       path: /etc/scylla/scylla.yaml
       regexp: "rpc_address: localhost"
       line: "rpc_address: {{ inventory_hostname }}"
   # Add the first host as seed {{ groups['all'][0] }}
   # Maybe this can be changed so that rather than host all, to isolate the first IP as seed node
   # Had to cheat the indent for this
   - name: Change seeds value to reflect first host on scylla.yaml
     ansible.builtin.lineinfile:
       path: /etc/scylla/scylla.yaml
       regexp: '- seeds: "127.0.0.1"'
       line: '          - seeds: "{{ groups[''all''][0] }}"'

   # Setup, run and version check
   - name: Run ScyllaDB setup
     command: scylla_setup --no-raid-setup --online-discard 1 --no-kernel-check --no-verify-package --no-coredump-setup --no-sysconfig-setup --io-setup 0 --no-cpuscaling-setup --no-rsyslog-setup --developer-mode
     # Setting serial might be best than to throttle a single section just to let the first node initialize
     #throttle: 1
     changed_when: false
     register: setup_output
   - debug: var=setup_output.stdout_lines
   # This need to be revised to use the built in functions of ansible (test the one below)
   # - name: Start scylla-server service
   #   systemd:
   #   name: scylla-server
   #   state: started
   #   enabled: yes
   - name: Run ScyllaDB as a service
     command: sudo systemctl start scylla-server
     changed_when: false

   # This should not be done
   # Reduced to 45, improving the service wait check should render this unnecessary
   - name: Pause for 45 seconds
     pause:
       seconds: 45

   - name: Check if scylla-server is running
     command: systemctl is-active scylla-server
     changed_when: false
     register: isactive
   - debug: var=isactive.stdout_lines

   # Use nodetool to check the cluster
   # NOTE TO SELF: nodetool wont be immediately available upon first init. Do a check to see if first setup has completed already.
   # 	Maybe check the logs for "init - serving" message
   - name: Check nodetool status
     command: nodetool status
     changed_when: false
     register: nodetool_output
   - debug: var=nodetool_output.stdout_lines
